<?xml version="1.0" encoding="UTF-8"?>  
    <!DOCTYPE mapper  
      PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"  
          "http://mybatis.org/dtd/mybatis-3-mapper.dtd">  


<mapper namespace="com.yuzhaibu.dao.MessageDao">
	<select id="findAllNotReadMessage" parameterType="java.util.Map" resultType="com.yuzhaibu.entity.Message">
		select 
		mes_id,
		mes_itemid,
		itemname as mes_itemname,
		itemmainimg as mes_itemmmainimg,
		mes_levuserid,
		u.username as mes_levusername,
		mes_content 
		FROM item i,message m,user_normal u 
		WHERE mes_touserid=#{userid} AND mes_status=1 AND i.itemid=m.mes_itemid and m.mes_levuserid=u.usernormal_id limit #{index},#{pageSize};
	</select>
	<select id="finddAllNotReadMessageCount" parameterType="java.util.Map" resultType="int">
		select count(1) FROM item i,message m,user_normal u 
		WHERE mes_touserid=#{userid} AND mes_status=1 AND i.itemid=m.mes_itemid and m.mes_levuserid=u.usernormal_id;
	</select>
	
	<select id="findItemMessageByItemId" parameterType="java.util.Map" resultType="com.yuzhaibu.entity.Message">
		select mes_id,mes_itemid,itemname as mes_itemname,itemmainimg as mes_itemmmainimg,mes_levuserid,u.username as mes_levusername,u.headimg as mes_levuserheadpic,mes_content FROM item i,message m,user_normal u 
		WHERE m.mes_itemid=#{itemid} and m.mes_status=1 and i.itemid =#{itemid} and u.usernormal_id=m.mes_levuserid limit #{index},#{pageSize};
	</select>
	
	<select id="findMesCountByItemId" parameterType="int" resultType="int">
		SELECT COUNT(*) from message where mes_itemid= #{itemid} and mes_status=1;
	</select>
	
	<update id="checkMesById" parameterType="int">
		update message set mes_status = 1 where mes_id = #{id} and mes_status=1;
	</update>
	
	<insert id="addMessage" parameterType="com.yuzhaibu.entity.Message">
		insert into message(mes_itemid,mes_levuserid,mes_touserid,mes_content,mes_status,createtime)
		values(
		#{mes_itemid},
		#{mes_levuserid},
		(select sellerid from item where itemid=#{mes_itemid} and sellstatus !=3),
		#{mes_content},
		0,
		now()
		);
	</insert>
	
</mapper>